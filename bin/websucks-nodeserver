#! /usr/bin/env node

/* Command line parser */
var cli = require('commander');

cli
    .version('0.17.0')
    .usage('[options]')
    .option('-s, --socket [type]', 'Unix socket [address]', '/tmp/websucks.sock')
    .option('-p, --port <n>', 'Websocket server port', parseInt, 9000)
    .option('-h, --host [ip]', 'Websocket server host IP', 'localhost')
    .parse(process.argv);

var io = require('socket.io').listen((cli.host, cli.port));
var net = require('net');
var events = require('events');

// Event emitter
var emitter = new events.EventEmitter();

// Unix socket server
var unix = net.createServer(function(socket) {
    console.log('Unix server connected');
    socket.on('end', function() {
	console.log('Unix server disconnected');
    });
    
    socket.on('data', function(data){
	emitter.emit("new_event", data)
    });
});

unix.listen(cli.socket, function() {
    console.log("Unix socket server started. and listen to %s", cli.socket);
});


io.configure(function () {
    io.set('transports', ['websocket']);
});

io.sockets.on('connection', function (socket) {
    socket.on('message', function (data) {
    });
    

    eventEmitter.on("new_event", function(data){
    });
    socket.on('disconnect', function () {
	console.log("disconnected");
    });
});
